@model IEnumerable<EstacionamentoMvc.Models.MovimentoEstacionamento>
@{
    ViewData["Title"] = "Lista de Ve√≠culos";
    bool mostrarTodos = ViewBag.MostrarTodos ?? false;
}

<div class="d-flex align-items-center justify-content-between mb-3 flex-wrap gap-2">
    <h2 class="m-0"><h2>üöó Ve√≠culos Cadastrados</h2>
</h2>
    <div class="d-flex gap-2">
        <a class="btn btn-primary btn-sm" asp-action="Entrada">+ Entrada Ve√≠culo</a>
        <a class="btn btn-secondary" id="toggleButton" asp-action="Index" asp-route-showAll="true">
            Mostrar Todos
        </a>
      <script>
      document.addEventListener("DOMContentLoaded", function () {
        const urlParams = new URLSearchParams(window.location.search);
        const showAll = urlParams.get("showAll");
        const btn = document.getElementById("toggleButton");
        if (showAll === "true") {
            btn.textContent = "Mostrar Ativos";
            btn.setAttribute("href", "?showAll=false");
        } else {
            btn.textContent = "Mostrar Todos";
            btn.setAttribute("href", "?showAll=true");
        }
      });
      </script>
    </div>
</div>

<table class="table table-bordered table-hover text-center align-middle shadow-sm">
        <thead class="table-light">
            <tr>
                <th>#</th>
                <th>Ve√≠culo</th>
                <th>Pre√ßo Inicial</th>
                <th>Hora/Fra√ß√£o</th>
                <th>Entrada</th>
                <th>Sa√≠da</th>
                <th>Perman√™ncia</th>
                <th>Valor Pago</th>
                <th>A√ß√µes</th>
            </tr>
        </thead>
        <tbody>
        @foreach (var item in Model)
        {
            <tr>
                <td>@item.Id</td>
                <td>@item.Veiculo</td>
                <td>R$ @item.PrecoInicial.ToString("N2")</td>
                <td>R$ @item.PrecoPorHora.ToString("N2")</td>
                <td>@item.DataEntrada.ToString("dd/MM/yyyy HH:mm:ss")</td>
                <td>@(item.DataSaida.HasValue ? item.DataSaida.Value.ToString("dd/MM/yyyy HH:mm:ss") : "‚Äî")</td>

                @if (item.DataSaida.HasValue)
                {
                    <td>@item.Permanencia</td>
                    <td>R$ @item.ValorPago.ToString("N2")</td>
                }
                else
                {
                    <td>‚Äî</td>
                    <td>‚Äî</td>
                }

                <td style="white-space:nowrap;">
                  <div class="d-flex gap-1">
                    <a asp-action="Detalhes" asp-route-id="@item.Id" class="btn btn-info btn-sm">üîç Detalhes</a>
                    <a class="btn btn-success btn-sm" asp-action="Baixa" asp-route-id="@item.Id">Baixa</a>
                    <a asp-action="Editar" asp-route-id="@item.Id" class="btn btn-warning btn-sm">‚úèÔ∏è Editar</a>
                    <a asp-action="Delete" asp-route-id="@item.Id" class="btn btn-danger btn-sm">üóë Excluir</a>
                </div>
            </td>

            </tr>
        }
        </tbody>
    </table>
@if (TempData["Msg"] != null)
{
    <div class="alert alert-success">@TempData["Msg"]</div>
}
@if (TempData["Erro"] != null)
{
    <div class="alert alert-danger">@TempData["Erro"]</div>
}

<!-- üîπ Modal Confirmar Baixa + Admin -->
<div class="modal fade" id="modalBaixa" tabindex="-1" aria-labelledby="modalBaixaLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <form asp-action="Baixa" method="post">
        <div class="modal-header">
          <h5 class="modal-title" id="modalBaixaLabel">üöó Confirmar Baixa</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fechar"></button>
        </div>

        <div class="modal-body">
          @* antiforgery √© injetado automaticamente pelo tag helper em POST *@
          <input type="hidden" name="id" id="mb-id" />

          <div class="mb-2">
            <label class="form-label">Ve√≠culo</label>
            <input class="form-control" id="mb-veiculo" readonly />
          </div>

          <div class="row g-2">
            <div class="col-6">
              <label class="form-label">Perman√™ncia (min)</label>
              <input class="form-control" id="mb-minutos" readonly />
            </div>
            <div class="col-6">
              <label class="form-label">Valor a pagar</label>
              <input class="form-control" id="mb-valor" readonly />
            </div>
          </div>

          <hr />
          <h6>üîê Ajustes (opcional ‚Äî somente Admin)</h6>
          <div class="row g-2">
            <div class="col-6">
              <input type="text" name="adminUser" class="form-control" id="mb-adminuser" placeholder="admin" />
            </div>
            <div class="col-6">
              <input type="password" name="adminPass" class="form-control" id="mb-adminpass" placeholder="1234" />
            </div>
          </div>

          <div class="row g-2 mt-2">
            <div class="col-6">
              <input type="number" step="0.01" name="descontoPercentual" class="form-control" placeholder="Desconto % (opcional)" />
            </div>
            <div class="col-6">
              <input type="number" step="1" name="descontoMinutos" class="form-control" placeholder="Desconto min (opcional)" />
            </div>
          </div>

          <small class="text-muted d-block mt-2">
            Regra: 15 minutos de toler√¢ncia. Valor estimado aqui; o valor final √© calculado no servidor.
          </small>
        </div>

        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
          <button type="submit" class="btn btn-success">Confirmar</button>
        </div>
      </form>
    </div>
  </div>
</div>

@section Scripts {
<script>
  // üî∏ Autofoco no usu√°rio admin ao abrir o modal
  document.getElementById('modalBaixa')
    .addEventListener('shown.bs.modal', function () {
      const user = document.getElementById('mb-adminuser');
      if (user) user.focus();
    });

  // üî∏ Preenche e calcula ao abrir o modal
  document.getElementById('modalBaixa')
    .addEventListener('show.bs.modal', function (event) {
      const btn = event.relatedTarget;
      const id = btn.getAttribute('data-id');
      const veiculo = btn.getAttribute('data-veiculo');
      const entradaIso = btn.getAttribute('data-entrada');
      const precoInicial = parseFloat(btn.getAttribute('data-precoinicial') || 0);
      const precoPorHora = parseFloat(btn.getAttribute('data-precoporhora') || 0);

      // Preenche campos
      document.getElementById('mb-id').value = id;
      document.getElementById('mb-veiculo').value = veiculo;

      // C√°lculo estimado no cliente (toler√¢ncia 15 min)
      const entrada = new Date(entradaIso);
      const agora = new Date();
      const minutosTotais = Math.max(1, Math.ceil((agora - entrada) / 60000));
      const cobrados = Math.max(0, minutosTotais - 15);
      const valor = precoInicial + (cobrados / 60) * precoPorHora;

      document.getElementById('mb-minutos').value = minutosTotais.toString();
      document.getElementById('mb-valor').value = valor.toLocaleString('pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
    });
</script>
}
